var LSB=LSB||{};LSB.markers=[],LSB.map,LSB.infowindow,LSB.soundEffect,LSB.activeOldSale,LSB.wsURL="http://83.254.136.119:8080",$(document).ready(function(){LSB.initialize(),LSB.loadOldSales()}),LSB.adjustValues=function(e){e.commission=e.commission/100,e.ordervalue=e.ordervalue/100},LSB.countUp=function(e,a){if($("#newSaleHere .commission").text(e+":-"),a>e){e++;var t=500-10*e-e;50>t&&(t=50),setTimeout(function(){LSB.countUp(e,a)},t)}},LSB.getNiceTime=function(e){var a=new Date(1e3*e);return LSB.showTwoDigits(a.getDate())+"/"+LSB.showTwoDigits(a.getMonth()+1)+" "+LSB.showTwoDigits(a.getHours())+":"+LSB.showTwoDigits(a.getMinutes())},LSB.goTo=function(e){var a=0;LSB.activeOldSale&&$(e).offset().top>$(LSB.activeOldSale).offset().top&&(a=$(LSB.activeOldSale).height()),$(e).trigger("click"),console.log("extra: "+a),$("#oldSalesHere").animate({scrollTop:$(e).offset().top-a},1e3)},LSB.initialize=function(){var e={center:new google.maps.LatLng(61.2414558923,13.6872133305),zoom:5};LSB.map=new google.maps.Map(document.getElementById("map-canvas"),e);var a=io.connect(LSB.wsURL);a.on("newSale",function(e){LSB.plotSale(JSON.parse(e),!0)}),LSB.soundEffect=new Audio("audio/1.mp3"),$("#oldSalesHere").css("height",$(document).height())},LSB.loadOldSales=function(){$.getJSON("cache.json",function(e){$(e).each(function(){LSB.plotSale(this,!1)})})},LSB.plotSale=function(e,a){LSB.adjustValues(e);var t=new google.maps.LatLng(e.geoObject.latitude,e.geoObject.longitude),n=new google.maps.Marker({position:t,map:LSB.map,title:e.program});e.marker=n,e.myLatlng=t;var l=LSB.plotSaleInList(e);if(google.maps.event.addListener(n,"click",function(){LSB.goTo(l)}),a){n.setAnimation(google.maps.Animation.BOUNCE),LSB.map.setZoom(8),LSB.map.setCenter(t),LSB.soundEffect.play(),$("#newSaleHere").empty();var o=LSB.produceSaleDiv(e);$("#newSaleHere").append("<h2>NY SALE!</h2>"),$("#newSaleHere").append(o),LSB.countUp(0,e.commission),$("#newSaleHere .percentage").hide(),setTimeout(function(){n.setAnimation(null),LSB.soundEffect.pause(),LSB.map.setZoom(5),$("#newSaleHere .percentage").show(),$("#newSaleHere h2").text("Senaste sale")},2e4)}},LSB.plotSaleInList=function(e){var a=$("<a>",{href:"#","class":"oldsaleitem"});$(a).append('<span class="fixedWidth commission">'+e.commission+':-</span><span class="fixedWidth">'+LSB.getNiceTime(e.ordertime)+'</span><span class="fixedWidth">'+e.program+'</span><div class="clearfix"></div>'),$("#oldSalesHere").prepend(a);var t=LSB.produceSaleDiv(e);return $(t).hide(),$(a).after(t),$(a).on("click",function(){return LSB.activeOldSale&&($(LSB.activeOldSale).slideUp(),LSB.activeMarker.setAnimation(null)),LSB.activeOldSale!==t?($(t).slideDown(),LSB.map.setZoom(6),LSB.map.setCenter(e.myLatlng),e.marker.setAnimation(google.maps.Animation.BOUNCE),LSB.activeMarker=e.marker,LSB.activeOldSale=t):(LSB.activeOldSale=null,LSB.activeMarker=null),$(a).blur(),!1}),a},LSB.produceSaleDiv=function(e){var a=$("<table>",{"class":"table table-bordered"});return a.append('<tr><td rowspan="2">Ersättning</td><td><span class="lead bigfont text-info commission">'+e.commission+" kronor</span></td></tr>"),a.append('<tr><td class="percentage">Ordersumma på '+e.ordervalue+":-</td></tr>"),a.append('<tr><td>Sale från</td><td><span class="label label-primary">'+e.program+'</span> på <span class="label label-info">'+e.channel+"</span></td></tr>"),a.append('<tr><td>Referens</td><td><a href="'+e.referrer+'">Länk</a></td></tr>'),a.append('<tr><td>Affiliatenätverk</td><td><span class="label label-danger">'+e.network+"</span></td></tr>"),a.append('<tr><td>EPI</td><td><span class="label label-warning">'+e.epi+"</span></td></tr>"),a.append('<tr><td>Användare från</td><td><span class="label label-success">'+e.geoObject.city+"</span></td></tr>"),a.append('<tr><td colspan="2"><span class="label label-default speciallabel">Sökord: '+e.ect_keyword+'</span> <span class="label label-default speciallabel">Ranking: '+e.ect_rank+'</span> <span class="label label-default speciallabel">IP: '+e.ip+'</span> <span class="label label-default speciallabel">Klick: '+LSB.getNiceTime(e.clicktime)+'</span> <span class="label label-default speciallabel">Avslut: '+LSB.getNiceTime(e.ordertime)+"</span></td></tr>"),$("<div></div>").append(a)},LSB.showDetails=function(e,a){LSB.infowindow&&LSB.infowindow.close(),LSB.infowindow=new google.maps.InfoWindow({content:e,maxWidth:500}),LSB.infowindow.open(LSB.map,a)},LSB.showTwoDigits=function(e){return 10>e?"0"+e:e};